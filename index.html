<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>အာကာစိုး Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Padauk:wght@400;700&display=swap');
        
        body {
            font-family: 'Roboto', 'Padauk', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden;
            background-color: #f8f9fa;
        }

        /* Google Sheets Grid Style */
        .sheet-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .table-viewport {
            flex: 1;
            overflow: auto;
            position: relative;
            border-top: 1px solid #dee2e6;
        }

        table {
            border-collapse: collapse;
            background: white;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #e0e0e0;
            padding: 0;
            width: 70px; /* Standard cell width */
            height: 35px; /* Standard cell height */
            text-align: center;
            font-size: 13px;
        }

        /* Headers Style */
        th {
            background-color: #f8f9fa;
            color: #5f6368;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .row-header {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            color: #5f6368;
            z-index: 45;
            width: 40px !important;
        }

        .sticky-corner {
            z-index: 60;
            left: 0;
            top: 0;
        }

        /* Selection & Highlight */
        .selected-cell {
            outline: 2px solid #1a73e8;
            outline-offset: -2px;
            background-color: #e8f0fe !important;
            z-index: 40;
        }

        .path-highlight {
            background-color: #fff4e5 !important;
        }

        /* Smart Toolbar (Floating Bottom) */
        .smart-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .toolbar-hidden {
            transform: translateY(100%);
        }

        /* Zoom Wrapper */
        .zoom-container {
            transform-origin: 0 0;
            width: max-content;
        }

        /* Path SVG */
        #path-svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 30;
        }

        .connection-line {
            fill: none;
            stroke: #fbab2c;
            stroke-width: 2;
            opacity: 0.6;
        }

        .comment-indicator {
            position: absolute;
            top: 0;
            right: 0;
            border-style: solid;
            border-width: 0 6px 6px 0;
            border-color: transparent #ea4335 transparent transparent;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const App = () => {
            const [data, setData] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            const [styles, setStyles] = useState({});
            const [comments, setComments] = useState({});
            const [zoom, setZoom] = useState(1.0);
            const [showToolbar, setShowToolbar] = useState(false);
            const [search, setSearch] = useState("");
            const [lineCoords, setLineCoords] = useState([]);
            
            const tableRef = useRef(null);
            const timerRef = useRef(null);

            // Fetch Data
            useEffect(() => {
                fetch('data.json')
                    .then(res => res.json())
                    .then(json => setData(json))
                    .catch(err => console.error("Error loading data", err));
                
                // Load preferences
                setStyles(JSON.parse(localStorage.getItem('la_styles') || '{}'));
                setComments(JSON.parse(localStorage.getItem('la_comments') || '{}'));
            }, []);

            // Organize Grid
            const organized = useMemo(() => {
                const map = {};
                data.forEach(item => {
                    const d = new Date(item.date);
                    const y = d.getFullYear();
                    if (!map[y]) map[y] = Array(24).fill("");
                    const idx = d.getMonth() * 2 + (d.getDate() >= 16 ? 1 : 0);
                    map[y][idx] = String(item.number);
                });
                const years = Object.keys(map).sort().map(Number);
                if (years.length === 0) years.push(new Date().getFullYear());
                const lastYear = years[years.length - 1];
                if (!map[lastYear + 1]) map[lastYear + 1] = Array(24).fill("");
                years.push(lastYear + 1);
                return { map, years };
            }, [data]);

            const activeNum = search || (selectedId ? organized.map[selectedId.split('-')[0]]?.[selectedId.split('-')[1]] : null);

            // Logic: Auto-hide toolbar
            const startTimer = () => {
                if (timerRef.current) clearTimeout(timerRef.current);
                timerRef.current = setTimeout(() => setShowToolbar(false), 8000); // 8 seconds
            };

            const handleCellClick = (id) => {
                setSelectedId(id);
                setShowToolbar(true);
                startTimer();
            };

            // Drawing Lines
            useEffect(() => {
                if (!activeNum) { setLineCoords([]); return; }
                const coords = [];
                organized.years.forEach(y => {
                    organized.map[y]?.forEach((val, r) => {
                        if (val === activeNum && val !== "") {
                            const el = document.querySelector(`[data-id="${y}-${r}"]`);
                            if (el) {
                                coords.push({
                                    x: el.offsetLeft + el.offsetWidth / 2,
                                    y: el.offsetTop + el.offsetHeight / 2
                                });
                            }
                        }
                    });
                });
                setLineCoords(coords);
            }, [activeNum, organized, zoom]);

            return (
                <div className="sheet-container">
                    {/* Header bar */}
                    <div className="h-12 bg-white flex items-center px-4 justify-between border-b z-50">
                        <div className="flex items-center gap-2">
                            <i data-lucide="table" className="text-green-600 w-5 h-5"></i>
                            <span className="font-medium text-gray-700">အာကာစိုး (Smart Grid)</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="relative">
                                <input 
                                    className="bg-gray-100 rounded-full px-8 py-1 text-sm outline-none focus:ring-2 ring-blue-500 w-32" 
                                    placeholder="Search..."
                                    value={search} onChange={e => setSearch(e.target.value)}
                                />
                                <i data-lucide="search" className="w-3.5 h-3.5 absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                            <button onClick={() => setShowToolbar(!showToolbar)}>
                                <i data-lucide="more-vertical" className="w-5 h-5 text-gray-500"></i>
                            </button>
                        </div>
                    </div>

                    {/* Table Viewport */}
                    <div className="table-viewport no-scrollbar" onScroll={() => setShowToolbar(false)}>
                        <div className="zoom-container" style={{ transform: `scale(${zoom})` }}>
                            <svg id="path-svg" width="2000" height="1500">
                                {lineCoords.length > 1 && (
                                    <path className="connection-line" d={`M ${lineCoords[0].x} ${lineCoords[0].y} ${lineCoords.slice(1).map(c => `L ${c.x} ${c.y}`).join(' ')}`} />
                                )}
                            </svg>
                            <table ref={tableRef}>
                                <thead>
                                    <tr>
                                        <th className="row-header sticky-corner"></th>
                                        {organized.years.map(y => <th key={y}>{y}</th>)}
                                    </tr>
                                </thead>
                                <tbody>
                                    {Array.from({ length: 24 }).map((_, rIdx) => (
                                        <tr key={rIdx}>
                                            <td className="row-header">{rIdx + 1}</td>
                                            {organized.years.map(y => {
                                                const id = `${y}-${rIdx}`;
                                                const val = organized.map[y][rIdx];
                                                const isSelected = selectedId === id;
                                                const isHigh = activeNum && val === activeNum && val !== "";
                                                const cellStyle = styles[id] || {};

                                                return (
                                                    <td 
                                                        key={y} 
                                                        data-id={id}
                                                        onClick={() => handleCellClick(id)}
                                                        className={`${isSelected ? 'selected-cell' : ''} ${isHigh ? 'path-highlight' : ''}`}
                                                        style={{ backgroundColor: cellStyle.bg || 'transparent' }}
                                                    >
                                                        <span className="relative z-10">{val}</span>
                                                        {comments[id] && <div className="comment-indicator"></div>}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Google Sheets Style Toolbar (Bottom Sheet) */}
                    <div className={`smart-toolbar p-4 ${showToolbar ? '' : 'toolbar-hidden'}`}>
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">Editor Tool</span>
                            <div className="flex gap-4">
                                <button onClick={() => setZoom(z => Math.max(0.5, z - 0.1))} className="p-1"><i data-lucide="zoom-out" className="w-4 h-4"></i></button>
                                <button onClick={() => setZoom(z => Math.min(2, z + 0.1))} className="p-1"><i data-lucide="zoom-in" className="w-4 h-4"></i></button>
                                <button onClick={() => setShowToolbar(false)} className="p-1"><i data-lucide="chevron-down" className="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <div className="flex gap-3 mb-4 overflow-x-auto pb-2 no-scrollbar">
                            <div className="flex-1 min-w-[120px]">
                                <label className="text-[10px] text-gray-500 font-bold ml-1">VALUE</label>
                                <input 
                                    className="w-full border rounded-lg p-2 font-bold text-center bg-gray-50 focus:bg-white border-blue-200"
                                    value={selectedId ? (organized.map[selectedId.split('-')[0]]?.[selectedId.split('-')[1]] || "") : ""}
                                    placeholder="Enter No."
                                    onChange={(e) => {/* Add save logic here */}}
                                />
                            </div>
                            <div className="flex-[2] min-w-[180px]">
                                <label className="text-[10px] text-gray-500 font-bold ml-1">COMMENT</label>
                                <input 
                                    className="w-full border rounded-lg p-2 text-sm bg-gray-50"
                                    value={selectedId ? (comments[selectedId] || "") : ""}
                                    placeholder="Add a note..."
                                    onChange={(e) => {/* Add save logic here */}}
                                />
                            </div>
                        </div>

                        <div className="flex justify-around items-center border-t pt-3">
                            {['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#a855f7', ''].map((color, i) => (
                                <button 
                                    key={i}
                                    className="w-8 h-8 rounded-full border border-gray-200 flex items-center justify-center"
                                    style={{ backgroundColor: color || 'white' }}
                                    onClick={() => {/* Add style save logic */}}
                                >
                                    {!color && <i data-lucide="eraser" className="w-4 h-4 text-gray-400"></i>}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Zoom Indicator */}
                    <div className="fixed bottom-4 right-4 bg-black/60 text-white text-[10px] px-2 py-1 rounded-full pointer-events-none">
                        Zoom: {Math.round(zoom * 100)}%
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Initialize Lucide icons
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
